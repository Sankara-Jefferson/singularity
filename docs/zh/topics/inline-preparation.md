# 行内准备

## 概述

传统的数据准备方法是将原始数据源（很可能是本地文件系统中的文件夹）转换为一堆每个小于32GiB的CAR文件。这为数据处理者带来了一个新的问题。如果他们要准备一PiB的数据集，他们需要再提供另一个PiB的存储服务器来存储这些CAR文件。

行内准备通过将这些CAR文件的块映射回原始数据源来解决这个问题，因此无需存储导出的CAR文件。

## CAR文件检索如何工作

使用行内准备，可以使用元数据数据库和原始数据源通过HTTP提供CAR文件，因为它知道如何将CAR文件的某些字节范围映射回原始数据源。&#x20;

要通过HTTP提供CAR文件，只需启动内容提供程序，可选地将其置于反向代理之后

```sh
singularity run content-provider
```

这会创建另一个挑战，如果数据源已经是远程存储系统，即S3或FTP，则文件内容仍然通过sinularity内容提供程序代理到存储提供程序。

我们有一个解决方案，可以使用singularity元数据API和singularity下载实用程序来解决

```bash
singularity run api
singularity download <piece_cid>
```

Singualrity元数据API将返回如何从原始数据源中组装CAR文件的计划，而singularity下载实用程序将解释此计划并从原始数据流式传输到本地CAR文件中。中间没有进行任何转换或组装，一切都按流处理。

元数据API不返回访问原始数据源所需的任何凭据，因此存储提供程序需要获取其自己的访问数据源的凭据，并将这种凭据提供给singularity下载命令。

## 开销

行内准备带来了非常小的开销。

由于我们需要为每个数据块存储一个数据库行，因此对于我们准备的每个1MiB的数据块，我们需要100字节。对于1PiB的数据集，数据库将需要10TiB的磁盘空间来存储这样的映射元数据。这通常不是问题，但对于具有大量小文件的数据集，磁盘开销将更大。

以后当我们从原始数据源动态重新生成CAR文件时，我们将需要在数据库中检查这些映射。这通常不是问题，因为1GB / sec的带宽相当于在所有支持的数据库后端的瓶颈以下的1000个条目查找，而且可能会有未来的优化减少这种开销。

## 启用行内准备

行内准备对于所有不需要加密的数据集始终启用。创建包含指定输出目录的数据集时，CAR文件将导出到这些目录中。在这种情况下，CAR检索请求将首先从这些目录中提供，并在用户删除这些CAR文件时回退到原始数据源。

## 相关资源

[download.md](../cli-reference/download.md "mention")